<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.2.0
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    <title>Per request debugging with Log4j 2 filters</title>
    <meta name="description" content="Customers quite regularly call on me to support them when an application is not behaving as expected. On a development machine there are a lot of ways and ut...">
    <link rel="canonical" href="https://aheusingfeld.github.io/software%20development/per-request-debugging-with-log4j2/">
  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/skins/default.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Overthinker&#39;s Thoughts" href="/feed.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

</head>


  <body class="layout--single  per-request-debugging-with-log4j-2-filters">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/posts/">Blog</a></li><li><a href="/categories/talks">Talks</a></li><li><a href="/tags/">Tags</a></li><li><a href="/about/">About Me</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/" class="site-logo" rel="home" title="Overthinker's Thoughts">
        <img src="/gfx/alex-blog.jpg" class="site-logo-img animated fadeInDown" alt="Overthinker's Thoughts">
      </a>
    
    
    
      
        <div class="site-title animated fadeIn"><a href="/">Overthinker's Thoughts</a></div>
      
      <p class="site-description animated fadeIn" itemprop="description">My 2cts on software architecture, digital transformation, and other concerns</p>
    
  </div>
</header><!-- /.masthead -->


    <div id="main" role="main" class="main-content" aria-label="Content">

  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">Per request debugging with Log4j 2 filters
</h1>
        
        

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2015-05-08T00:00:00+02:00">2015-05-08</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


      </header>

      <div class="page-content">
        <div class="e-content">
          <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>I wrote a post on the innoQ blog about <a href="https://www.innoq.com/en/blog/per-request-debugging-with-log4j2/">"Per request debugging with Log4j 2 filters"</a>.</p>
</div>
<hr>
<div class="paragraph">
<p>The bare minimum that should be available are the application’s log messages, so that’s probably the simplest thing to start with. From what I saw, in most production environments log output is unfortunately reduced to the absolute minimum for the sake of system performance and resource efficiency. In those environments it would be ok to increase the logging for a certain portion of the traffic, e.g. just for one incoming HTTP request, but this seems to be quite complicated. In this post I’d like to show you that it isn’t.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="''logging_in_java">Logging in Java</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the Java ecosystem we are free to choose from a variety of logging frameworks to help us get the job done. There is the time-honoured Apache Log4J, it’s so-called successor Logback and the SLF4J API which became quite popular. But with this post I’d like to direct your attention to Log4J’s new major version release <a href="https://logging.apache.org/log4j/2.0/">Apache Log4j 2</a>. Apart from greater performance and numerous bugfixes, Log4j 2 also comes with some new and optimised features which we can use to accomplish our task.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="''the_building_blocks">The building blocks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first thing we need is a place to intercept the HTTP request, extract the appropriate HTTP header and add it to Log4j’s <code>ThreadContext</code>. The <code>ThreadContext</code> is a "Mapped Diagnostic Context" (MDC) which is also known from other logging frameworks. Below you will find a naive implementation of a <code>ServletFilter</code> which does exactly this, assuming that the parameter to enable debugging is a boolean HTTP header like <code>x-debug-enabled: true</code>. Of course you can use any other request parameter you like.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">package com.innoq.blog.samples;

import org.apache.logging.log4j.ThreadContext;

import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;

/**
 * ServletFilter to extract request data and add it to Log4j's ThreadContext.
 */
public class RequestDebugFilter implements Filter {

    public static final String DEBUG_HEADER = "x-debug-enabled";

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {

        try {
            // NOTE: Parsing for a "Boolean" makes sure that ThreadContext does not contain the random value that someone put into the HTTP header!
            Boolean debugHeaderEnabled = Boolean.valueOf(((HttpServletRequest)request).getHeader(DEBUG_HEADER));
            if (debugHeaderEnabled) {
                ThreadContext.put(DEBUG_HEADER, debugHeaderEnabled.toString());
            }

            chain.doFilter(request, response);
        } finally {
            ThreadContext.remove(DEBUG_HEADER);
        }
    }

    /* ... further methods abbreviated... */
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we got the parameter in our <code>ThreadContext</code>, we don’t need any further code changes, but can solely focus on the Log4j 2 configuration. In our Log4j configuration we can now make use of the <a href="https://logging.apache.org/log4j/2.0/manual/filters.html#DynamicThresholdFilter">DynamicThresholdFilter</a> to generally change the log level to TRACE in case the parameter "x-debug-enabled" is set to "true". A simple yet complete <code>log4j2.xml</code> file doing this could look like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Configuration monitorInterval="30"&gt;

    &lt;!-- This filter is used to generally enable TRACE logging if "x-debug-enabled" in the ThreadContext has the value "true" --&gt;
    &lt;DynamicThresholdFilter key="x-debug-enabled" onMatch="ACCEPT" onMismatch="NEUTRAL"&gt;
        &lt;KeyValuePair key="true" value="TRACE"/&gt;
    &lt;/DynamicThresholdFilter&gt;

    &lt;Appenders&gt;
        &lt;Console name="CONSOLE" target="SYSTEM_OUT" &gt;
            &lt;JSONLayout compact="true" charset="utf-8" eventEol="true" properties="true"/&gt;
        &lt;/Console&gt;
    &lt;/Appenders&gt;

    &lt;Loggers&gt;
        &lt;Root level="info"&gt;
            &lt;AppenderRef ref="CONSOLE"/&gt;
        &lt;/Root&gt;
    &lt;/Loggers&gt;
&lt;/Configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this in hand we might even decide that we want to write those special HTTP requests to a different log file. This can be done by adding the following snippet to our <code>log4j2.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">&lt;RollingFile name="DEBUGLOGFILE" fileName="logs/debug.log" filePattern="logs/debug-%d{yyyyMMdd_HH}-%i.log.gz"&gt;
    &lt;Filters&gt;
      	&lt;ThreadContextMapFilter onMatch="ACCEPT" onMismatch="DENY"&gt;
            &lt;KeyValuePair key="x-debug-enabled" value="true"/&gt;
        &lt;/ThreadContextMapFilter&gt;
    &lt;/Filters&gt;
    &lt;Policies&gt;
        &lt;OnStartupTriggeringPolicy /&gt;
        &lt;TimeBasedTriggeringPolicy /&gt;
    &lt;/Policies&gt;
    &lt;PatternLayout charset="UTF-8"&gt;
        &lt;PatternLayout pattern="[[%d{ISO8601}||%X||%-5p||%t||%c{1.}||%m]]%n"/&gt;
    &lt;/PatternLayout&gt;
&lt;/RollingFile&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we are using a <a href="https://logging.apache.org/log4j/2.0/manual/filters.html#ThreadContextMapFilter">ThreadContextMapFilter</a> to ACCEPT log messages only in case the <code>x-debug-enabled</code> parameter in the <code>ThreadContext</code> map is set to <code>true</code>. Otherwise the log message is DENIED meaning not written to this RollingFile appender.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="''conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We’ve just shown how to enable <code>TRACE</code> logging with Log4j 2 on a per-request basis, but of course this isn’t limited to HTTP requests. Any parameter in the <code>ThreadContext</code> can be used as a trigger. Therefore it is possible to debug batch jobs which have a certain flag, WebSocket connections or any other thread-based processing.</p>
</div>
<div class="paragraph">
<p>The Log4j 2 manual has a lot more information and also explains use cases for new features. I recommend you read through it if you want to gain a deeper understanding. If you happen to read German, you might also be interested in the introductory article on Log4j 2 <a href="https://www.innoq.com/de/articles/2015/01/logging-konsolidieren-log4j2/">"Logging konsolidieren und Performance gewinnen"</a> by my colleagues Stefan and Phillip.</p>
</div>
</div>
</div>
        </div>

        <footer class="page__meta">
          
          <!-- 
  <h3 class="page-taxonomies-title">Categories</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">software development</li>
  </ul>

 -->
          
  <h3 class="page-taxonomies-title">Tags</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">software development</li><li class="page-taxonomy">java</li><li class="page-taxonomy">logging</li><li class="page-taxonomy">debugging</li><li class="page-taxonomy">log4j</li><li class="page-taxonomy">innoq</li><li class="page-taxonomy">article</li><li class="page-taxonomy">external</li>
  </ul>


          

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2015-05-08T00:00:00+02:00">2015-05-08</time></p>


        </footer>
        
          <div class="page-share">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Faheusingfeld.github.io%2Fsoftware%2520development%2Fper-request-debugging-with-log4j2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--facebook btn--small"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i> <span>Share</span></a>
  <a href="https://twitter.com/intent/tweet?text=Per+request+debugging+with+Log4j+2+filters%20https%3A%2F%2Faheusingfeld.github.io%2Fsoftware%2520development%2Fper-request-debugging-with-log4j2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--twitter btn--small"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i> <span>Tweet</span></a>
  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Faheusingfeld.github.io%2Fsoftware%2520development%2Fper-request-debugging-with-log4j2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--linkedin btn--small"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> <span>LinkedIn</span></a>
  <a href="https://reddit.com/submit?title=Per+request+debugging+with+Log4j+2+filters&url=https%3A%2F%2Faheusingfeld.github.io%2Fsoftware%2520development%2Fper-request-debugging-with-log4j2%2F" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" class="btn btn--reddit btn--small"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> <span>Reddit</span></a>
</div>

        

        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/hosting/migrate-owncloud/">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> Migrate Owncloud from PostgreSQL to MySQL

      </span>
    </a>
  

  
    <a class="page-next" href="/organisation/innovation-tokens-jaxenter/">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        Article on Innovation Tokens at jaxenter
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="/feed.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a><a class="social-icon" href="/imprint"><i class="fas fa-info fa-2x" title="Imprint & Privacy"></i></a><a class="social-icon" href="https://speakerdeck.com/u/aheusingfeld"><i class="fab fa-fw fa-slideshare fa-2x" title=""></i></a><a class="social-icon" href="https://mstdn.social/@aheusingfeld"><i class="fas fa-user fa-2x" title=""></i></a></div><div class="copyright">
    
      <p>&copy; 2023 Alexander Heusingfeld. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>


  </body>

</html>
