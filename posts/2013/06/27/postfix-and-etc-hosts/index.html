<!DOCTYPE html><!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]--><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Postfix and /etc/hosts | goldstift's blog</title><meta name="author" content="Alexander Heusingfeld"><meta name="twitter:card" content="summary"><meta name="twitter:creator" content="@goldstift"><meta name="twitter:url" content="http://aheusingfeld.github.io/posts/2013/06/27/postfix-and-etc-hosts/"><meta name="twitter:title" content="Postfix and /etc/hosts"><meta name="twitter:description" content="The following post is actually a note2self as I stumbled over this problem and wanted to create a reminder for myself and others with similar..."><link rel="alternate" type="application/atom+xml" title="goldstift\s blog" href="http://aheusingfeld.github.io/atom.xml"><link rel="shortcut icon" href="http://goldstift.de/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/stylesheets/jquery.mobile-1.3.2.min.css"><link rel="stylesheet" href="/stylesheets/styles.css"><script src="/javascripts/vendor/custom.modernizr.js"></script><!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--><style  type="text/css">@font-face { font-family: 'Open Sans'; font-style: normal; font-weight: 400; src: local('Open Sans'), local('OpenSans'), url(/fonts/OpenSans-Regular.woff) format('woff');}@font-face { font-family: 'Open Sans'; font-style: normal; font-weight: 700; src: local('Open Sans Bold'), local('OpenSans-Bold'), url(/fonts/OpenSans-Bold.woff) format('woff');}@font-face { font-family: 'Open Sans'; font-style: italic; font-weight: 400; src: local('Open Sans Italic'), local('OpenSans-Italic'), url(/fonts/OpenSans-Italic.woff) format('woff');}</style></head><body class="antialiased (page.body-class)"><div id="wrapper" data-role="page" data-theme="d"><div id="top-panel" data-role="header" data-position="fixed" data-theme="d"><h2>goldstift's 2 cent on technology and software development</h2><a class="jqm-navmenu-link" href="#nav-menu-panel" data-icon="bars" data-iconpos="notext">Navigation</a></div><main id="content" data-role="content"><article class="post" itemscope="" itemtype="http://schema.org/BlogPosting" role="article"><header><h1 itemprop="headline">Postfix and /etc/hosts</h1><div class="meta" aria-role="status" aria-label="Meta information on the current blog post."><span class="permalink"><a class="icon-permalink" href="/posts/2013/06/27/postfix-and-etc-hosts/" itemprop="url" aria-label="Permalink for blog post Postfix and /etc/hosts" title="Permalink for blog post Postfix and /etc/hosts"><span class="linktext">"Permalink for blog post 'Postfix and /etc/hosts'"</span></a></span><span class="author" itemprop="author">Alexander Heusingfeld</span> <time class="pubdate" datetime="2013-06-27T21:00:00+00:00" itemprop="datePublished">27. June 2013</time></div></header><section itemprop="articleBody"><p>The following post is actually a note2self as I stumbled over this problem and wanted to create a reminder for myself and others with similar issues.</p>

<h3 id="scenario">Scenario</h3>
<p>"<strong>master</strong>" is the host machine for multiple virtual machines (in my case they are run and managed via "libvirt").
One of these virtual machines is "<strong>mail-host</strong>" which holds a postfix mailserver. All of the machines are using an externally managed DNS server.
The virtual machines are only available to the outside world via NAT. They don't have public IP addresses and therefore aren't known to the external DNS server.</p>

<p>The last point is actually the reason for this post:</p>

<p><strong>How do I configure postfix to forward mails for "example.org" to another server if DNS states that localhost is "example.org"?</strong></p>

<p></p>

<h3 id="the-requirement">The Requirement</h3>

<p>We're running things like "rkhunter", "fail2ban" or "unattended-upgrades" on the 
master which all would like to inform root via mail about certain things going on. </p>

<p>BTW: If /usr/bin/mail isn't installed, yet, you can do so via</p>

<pre><code>$ sudo apt-get install bsd-mailx
</code></pre>

<p>This will also install a slim variant of postfix on our "master" machine.</p>

<p>Next we create a mail forwarding for all mails which are send to root@master by simply creating a ".forward" file in root's home folder</p>

<pre><code>$ echo admin@example.org &gt; /root/.forward
</code></pre>

<p>If we now test our setup via</p>

<pre><code>$ echo Ouch, that doesn't work! | mail -s "test mail" root
</code></pre>

<p>we will see something like the following in your /var/log/mail.log</p>

<pre><code>Jun 27 19:34:35 master postfix/pickup[25736]: 8D6061341019: uid=0 from=&lt;root&gt;
Jun 27 19:34:35 master postfix/cleanup[25742]: 8D6061341019: message-id=&lt;20130627173435.8D6061341019@master.localdomain&gt;
Jun 27 19:34:35 master postfix/qmgr[25737]: 8D6061341019: from=&lt;root@master&gt;, size=504, nrcpt=1 (queue active)
Jun 27 19:34:35 master postfix/error[25744]: 8D6061341019: to=&lt;admin@example.org&gt;, orig_to=&lt;root&gt;, relay=none, delay=0.26, delays=0.2/0/0/0.06, dsn=5.0.0, status=bounced (example.org)
</code></pre>

<p>The DNS server tells "master" that he himself is "example.org" and therefore we have an endless loop for mail delivery. Postfix states this via the "status=bounced" error.</p>

<h3 id="configure-local-domain-resolution">Configure local domain resolution</h3>

<p>In the next step we need to tell the postfix on "master" that it should not query DNS for domain resolution of "example.org" 
but instead rely on /etc/hosts so we can resolve the IP of our virtual machine correctly.</p>

<pre><code>$ vi /etc/hosts
---
# IPv4
127.0.0.1 localhost
192.168.123.10	example.org mail.example.org
...
</code></pre>

<p>and additionally </p>

<pre><code>$ vi /etc/postfix/main.cf
---
....
relayhost = mail-host
inet_protocols = all
#lmtp_host_lookup = native
smtp_host_lookup=native
</code></pre>

<p>Now you can test your configuration by</p>

<pre><code>$ service postfix restart
$ echo Hi there, how are you? | mail -s "test mail" root
</code></pre>
</section><section class="tags" role="menu" aria-label="List of linked tags" itemprop="keywords"><i class="label icon-tags">tags: </i><a href="/posts/tags/linux" role="menuitem">linux, </a><a href="/posts/tags/postfix" role="menuitem">postfix, </a><a href="/posts/tags/kvm" role="menuitem">kvm </a></section><section id="comments" itemtype="http://schema.org/UserComments"><h2>Comments</h2><div id="disqus_thread"></div><script type="text/javascript">   /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */   var disqus_shortname = 'goldstift';   /* * * DON'T EDIT BELOW THIS LINE * * */   (function() {       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);   })();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a></section><footer><div class="row"><ul class="pager"><li class="previous span1"></li><li class="next span1 offset7"></li></ul></div></footer></article></main><section id="nav-menu-panel" data-role="panel" data-position="left" data-display="reveal" data-theme="c"><h3><Blog>Posts</Blog></h3><nav><ul id="innernav" data-role="listview" data-inset="true" role="menu"><li role="menuitem"><a href="/">Home</a></li><li role="menuitem"><a href="/about/">About Me</a></li><li class="divider" role="separator"></li><li class="post" role="menuitem"><span class="date">10 Sep 2013</span><a href="/posts/2013/09/10/First-steps-with-android/">&raquo;  First Steps with Android</a></li><li class="post" role="menuitem"><span class="date">08 Aug 2013</span><a href="/posts/2013/08/08/speaking-at-DOAG-SIG-Middleware/">&raquo;  Speaking at DOAG SIG Middleware 2013</a></li><li class="post" role="menuitem"><span class="date">06 Aug 2013</span><a href="/posts/2013/08/06/getting-started-with-clojure/">&raquo;  Getting started with Clojure</a></li><li class="post" role="menuitem"><span class="date">13 Jul 2013</span><a href="/posts/2013/07/13/speaking-at-javaone2013/">&raquo;  Speaking at JavaOne 2013</a></li><li class="post" role="menuitem"><span class="date">27 Jun 2013</span><a href="/posts/2013/06/27/postfix-and-etc-hosts/">&raquo;  Postfix and /etc/hosts</a></li><li class="post" role="menuitem"><span class="date">25 Apr 2013</span><a href="/posts/2013/04/25/collaborator-on-sonar-intellij-plugin/">&raquo;  Collaborator on Sonar IntelliJ Plugin</a></li><li class="post" role="menuitem"><span class="date">21 Apr 2013</span><a href="/posts/2013/04/21/speaking-at-javaforum-stuttgart/">&raquo;  I'm speaking at Java Forum Stuttgart 2013</a></li><li class="post" role="menuitem"><span class="date">20 Mar 2013</span><a href="/posts/2013/03/20/Mac-OS-X-for-java-developers/">&raquo;  Mac OS X setup tips & tricks</a></li><li class="post" role="menuitem"><span class="date">13 Dec 2012</span><a href="/posts/2012/12/13/Glassfish4-on-Nexus7/">&raquo;  Glassfish 4 on Nexus7</a></li><li class="post" role="menuitem"><span class="date">30 Nov 2012</span><a href="/posts/2012/11/30/Ubuntu+Java-on-Nexus7/">&raquo;  Ubuntu and Java on Nexus7</a></li><li class="post" role="menuitem"><span class="date">26 Nov 2012</span><a href="/posts/2012/11/26/Productivity-for-Finder/">&raquo;  Enhancements for Mac OS X Finder.app</a></li><li class="post" role="menuitem"><span class="date">03 Nov 2012</span><a href="/posts/2012/11/03/JBoss-Forge-in_IntelliJ/">&raquo;  JBoss Forge in IntelliJ IDEA</a></li><li class="post" role="menuitem"><span class="date">09 Oct 2012</span><a href="/posts/2012/10/09/JavaOne_Session-material-online/">&raquo;  JavaOne 2012 Session material is now available</a></li><li class="post" role="menuitem"><span class="date">25 Sep 2012</span><a href="/posts/2012/09/25/JavaOne/">&raquo;  Getting ready for JavaOne 2012</a></li><li class="post" role="menuitem"><span class="date">13 Mar 2012</span><a href="/posts/2012/03/13/alternative-zu-google-vielleicht-duckduckgo/">&raquo;  Alternative zu Google? Vielleicht DuckDuckGo</a></li><li class="post" role="menuitem"><span class="date">24 Oct 2011</span><a href="/posts/2011/10/24/springroo-howto-translate-java-exceptions-to-user-friendly-error-messages/">&raquo;  SpringRoo - Howto translate Java exceptions to user-friendly error messages</a></li><li class="post" role="menuitem"><span class="date">01 Oct 2011</span><a href="/posts/2011/10/01/iphone-wartezeit-f-r-rufumleitung-bei-abwesenheit-setzen/">&raquo;  iPhone - Wartezeit f√ºr Rufumleitung bei Abwesenheit setzen</a></li><li class="post" role="menuitem"><span class="date">25 Sep 2011</span><a href="/posts/2011/09/25/springroo-entity-klassen-und-jpa-repositories-mit-springroo-erstellen/">&raquo;  SpringRoo - Entity-Klassen und JPA-Repositories mit SpringRoo erstellen</a></li><li class="post" role="menuitem"><span class="date">23 Sep 2011</span><a href="/posts/2011/09/23/starting-photooapp-a-springroo-tutorial-application/">&raquo;  Starting PhotooApp - A SpringRoo tutorial application</a></li><li class="post" role="menuitem"><span class="date">05 Jun 2011</span><a href="/posts/2011/06/05/praxistipps-zu-ftplicity/">&raquo;  Praxistipps zu ftplicity</a></li><li class="post" role="menuitem"><span class="date">03 Jun 2011</span><a href="/posts/2011/06/03/how-to-set-default-comment-security-level-in-atlassian-jira/">&raquo;  How to Set Default Comment Security Level in Atlassian JIRA</a></li><li class="post" role="menuitem"><span class="date">13 Feb 2011</span><a href="/posts/2011/02/13/broken-special-chars-in-spring-roo/">&raquo;  Broken special chars in Spring Roo?</a></li><li class="post" role="menuitem"><span class="date">10 Feb 2011</span><a href="/posts/2011/02/10/umlaute-und-sonderzeichen-in-spring-roo/">&raquo;  Umlaute und Sonderzeichen in Spring Roo?</a></li><li class="post" role="menuitem"><span class="date">19 Jan 2011</span><a href="/posts/2011/01/19/probleme-beim-login-ins-elster-eportal-mit-mac-os-x/">&raquo;  Probleme beim Login ins Elster ePortal mit Mac OS X</a></li><li class="post" role="menuitem"><span class="date">22 Apr 2009</span><a href="/posts/2009/04/22/-letztlich-doch-hier/">&raquo;  ...letztlich doch hier</a></li></ul></nav></section><footer><small>&copy; 2013 by A. Heusingfeld - Hosted on <a href="https://github.com/aheusingfeld/aheusingfeld.github.io/">GitHub Pages</a></small></footer></div><script type="text/javascript" src="/javascripts/jquery-1.10.2.min.js"></script><script type="text/javascript" src="/javascripts/jquery.mobile-1.3.2.min.js"></script><script type="text/javascript" src="/javascripts/scale.fix.js"></script><!-- AddThis Smart Layers BEGIN --><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=goldstift"></script><script type="text/javascript"> addthis.layers({   'theme' : 'transparent',   'share' : {     'position' : 'left',     'numPreferredServices' : 4   },    'follow' : {     'services' : [       {'service': 'twitter', 'id': 'goldstift'}     ]   } });</script><!-- AddThis Smart Layers END --></body></html>