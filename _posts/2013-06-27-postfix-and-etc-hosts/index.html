<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.2.0
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    <title>Postfix and /etc/hosts</title>
    <meta name="description" content="My 2cts on software architecture, digital transformation, and other concerns">
    <link rel="canonical" href="https://aheusingfeld.github.io/_posts/2013-06-27-postfix-and-etc-hosts/">
  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/skins/default.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i|Lora:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Overthinker&#39;s Thoughts" href="/feed.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

</head>


  <body class="layout--single  postfix-and-etc-hosts">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/posts/">Blog</a></li><li><a href="/categories/talks">Talks</a></li><li><a href="/tags/">Tags</a></li><li><a href="/about/">About Me</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
      <a href="/" class="site-logo" rel="home" title="Overthinker's Thoughts">
        <img src="/gfx/alex-blog.jpg" class="site-logo-img animated fadeInDown" alt="Overthinker's Thoughts">
      </a>
    
    
    
      
        <div class="site-title animated fadeIn"><a href="/">Overthinker's Thoughts</a></div>
      
      <p class="site-description animated fadeIn" itemprop="description">My 2cts on software architecture, digital transformation, and other concerns</p>
    
  </div>
</header><!-- /.masthead -->


    <div id="main" role="main" class="main-content" aria-label="Content">

  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">Postfix and /etc/hosts
</h1>
        
        


      </header>

      <div class="page-content">
        <div class="e-content">
          <p>The following post is actually a note2self as I stumbled over this problem and wanted to create a reminder for myself and others with similar issues.</p>

<h3 id="scenario">Scenario</h3>

<p>“<strong>master</strong>” is the host machine for multiple virtual machines (in my case they are run and managed via “libvirt”).
One of these virtual machines is “<strong>mail-host</strong>” which holds a postfix mailserver. All of the machines are using an externally managed DNS server.
The virtual machines are only available to the outside world via NAT. They don’t have public IP addresses and therefore aren’t known to the external DNS server.</p>

<p>The last point is actually the reason for this post:</p>

<p><strong>How do I configure postfix to forward mails for “example.org” to another server if DNS states that localhost is “example.org”?</strong></p>

<h3 id="the-requirement">The Requirement</h3>

<p>We’re running things like “rkhunter”, “fail2ban” or “unattended-upgrades” on the 
master which all would like to inform root via mail about certain things going on.</p>

<p>BTW: If /usr/bin/mail isn’t installed, yet, you can do so via</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt-get install bsd-mailx
</code></pre></div></div>

<p>This will also install a slim variant of postfix on our “master” machine.</p>

<p>Next we create a mail forwarding for all mails which are send to root@master by simply creating a “.forward” file in root’s home folder</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo admin@example.org &gt; /root/.forward
</code></pre></div></div>

<p>If we now test our setup via</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ echo Ouch, that doesn't work! | mail -s "test mail" root
</code></pre></div></div>

<p>we will see something like the following in your /var/log/mail.log</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jun 27 19:34:35 master postfix/pickup[25736]: 8D6061341019: uid=0 from=&lt;root&gt;
Jun 27 19:34:35 master postfix/cleanup[25742]: 8D6061341019: message-id=&lt;20130627173435.8D6061341019@master.localdomain&gt;
Jun 27 19:34:35 master postfix/qmgr[25737]: 8D6061341019: from=&lt;root@master&gt;, size=504, nrcpt=1 (queue active)
Jun 27 19:34:35 master postfix/error[25744]: 8D6061341019: to=&lt;admin@example.org&gt;, orig_to=&lt;root&gt;, relay=none, delay=0.26, delays=0.2/0/0/0.06, dsn=5.0.0, status=bounced (example.org)
</code></pre></div></div>

<p>The DNS server tells “master” that he himself is “example.org” and therefore we have an endless loop for mail delivery. Postfix states this via the “status=bounced” error.</p>

<h3 id="configure-local-domain-resolution">Configure local domain resolution</h3>

<p>In the next step we need to tell the postfix on “master” that it should not query DNS for domain resolution of “example.org” 
but instead rely on /etc/hosts so we can resolve the IP of our virtual machine correctly.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vi /etc/hosts
---
# IPv4
127.0.0.1 localhost
192.168.123.10	example.org mail.example.org
...
</code></pre></div></div>

<p>and additionally</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vi /etc/postfix/main.cf
---
....
relayhost = mail-host
inet_protocols = all
#lmtp_host_lookup = native
smtp_host_lookup=native
</code></pre></div></div>

<p>Now you can test your configuration by</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ service postfix restart
$ echo Hi there, how are you? | mail -s "test mail" root
</code></pre></div></div>

        </div>

        <footer class="page__meta">
          
          <!-- 
  <h3 class="page-taxonomies-title">Categories</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">hosting</li>
  </ul>

 -->
          
  <h3 class="page-taxonomies-title">Tags</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">postfix</li><li class="page-taxonomy">kvm</li><li class="page-taxonomy">ubuntu</li><li class="page-taxonomy">linux</li><li class="page-taxonomy">self-hosting</li><li class="page-taxonomy">bugfix</li>
  </ul>


          

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2013-06-27T23:00:00+02:00">2013-06-27</time></p>


        </footer>
        

        

        <nav class="page-pagination" role="navigation">
  

  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="/feed.xml"><i class="fas fa-rss-square fa-2x" title="Feed"></i></a><a class="social-icon" href="/imprint"><i class="fas fa-info fa-2x" title="Imprint & Privacy"></i></a><a class="social-icon" href="https://speakerdeck.com/u/aheusingfeld"><i class="fab fa-fw fa-slideshare fa-2x" title=""></i></a><a class="social-icon" href="https://mstdn.social/@aheusingfeld"><i class="fas fa-user fa-2x" title=""></i></a></div><div class="copyright">
    
      <p>&copy; 2023 Alexander Heusingfeld. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>


  </body>

</html>
